(()=>{"use strict";var e={924:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(r(200)),i=r(982);class o extends a.default{constructor(e){super(e)}static fromBigNumber(e,t){return new o(i.ethers.utils.formatUnits(e,t))}static sum(...e){return new o(a.default.sum(e))}toBigNumber(e){return i.ethers.utils.parseUnits(`${this.toFixed(e)}`,e)}toString(){return this.toFixed()}toFixed(e,t){return super.toFixed(e,t||a.default.ROUND_FLOOR)}toFixedDecimal(e=8){return new o(this.toFixed(e))}mustBeInteger(){if(!this.isInteger())throw new Error(`Amount ${this} is not an integer!`);return this.toNumber()}plus(e){return new o(super.plus(e))}sub(e){return new o(super.sub(e))}mul(e){return new o(super.mul(e))}dividedBy(e){return new o(super.dividedBy(e))}div(e){return new o(super.div(e))}lt(e){return super.lt(e)}lte(e){return super.lte(e)}gt(e){return super.gt(e)}gte(e){return super.gte(e)}negated(){return new o(super.negated())}round(){return new o(super.round())}}t.default=o},881:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.returnErrorObject=void 0,t.default=class{returnErrorObject(e,r){return(0,t.returnErrorObject)(e,r)}},t.returnErrorObject=(e,t)=>JSON.stringify({message:e,code:t})},482:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{notFoundEarnEventException(e){return new Error(`Not Found Earn Event by ${e}`)}alreadyClaimed(e,t){return new Error(`Already Claimed Earn Event ${e} by user ${t}`)}notFoundAppInEarnEvent(e){return new Error(`Not Found App In Earn Event ${e}`)}notClaimablePeriod(e){return new Error(`Not Claimable Period Earn Event: ${e}`)}notEnoughClaimReward(e){return new Error(`Not Enough Claim Reward For Earn Event ${e}`)}notFoundCurrencyExchangeRate(e,t,r){return new Error(`Not Found Exchange Rate ${t}, ${r} for Earn Event ${e}`)}}},21:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(r(881));var i;!function(e){e.NOT_FOUND_APP="NOT_FOUND_APP",e.NOT_FOUND_CONNECTION_INFO="NOT_FOUND_CONNECTION_INFO",e.INVALID_JWT_TOKEN="INVALID_JWT_TOKEN",e.ALREADY_CONNECTED="ALREADY_CONNECTED",e.NOT_FOUND_CURRENCY="NOT_FOUND_CURRENCY",e.NOT_MATCHED_USER="NOT_MATCHED_USER",e.NOT_FOUND_EVENT="NOT_FOUND_EVENT",e.INVALID_KEY="INVALID_KEY",e.NOT_FOUND_EVENT_PARTICIPATION_LOG="NOT_FOUND_EVENT_PARTICIPATION_LOG",e.EXCEEDED_MAXIMUM_PARTICIPATION="EXCEEDED_MAXIMUM_PARTICIPATION",e.EXCEEDED_MAXIMUM_PARTICIPATION_PER_DAY="EXCEEDED_MAXIMUM_PARTICIPATION_PER_DAY",e.EXCEEDED_MAXIMUM_REWARD="EXCEEDED_MAXIMUM_REWARD",e.NOT_EVENT_PERIOD="NOT_EVENT_PERIOD"}(i||(i={}));class o extends a.default{notFoundApp(e){return new Error(this.returnErrorObject(`Not Found App: by ${e}`,i.NOT_FOUND_APP))}notFoundAppAndIdentifier(e,t){return new Error(this.returnErrorObject(`Not Found connection info by appId: ${e}${t?` and identifer: ${t}`:""}`,i.NOT_FOUND_CONNECTION_INFO))}invaliedThirdPartyJwt(e,t){return new Error(this.returnErrorObject(`Invalied JWT token: "${t}" for ${e}`,i.INVALID_JWT_TOKEN))}alreadyConnectedUser(e,t){return new Error(this.returnErrorObject(`Already connected to ${e} by identifier ${t}`,i.ALREADY_CONNECTED))}notFoundCurrency(e){return new Error(this.returnErrorObject(`Not Found Currency by alias: ${e}`,i.NOT_FOUND_CURRENCY))}notMatchThirdPartyIdentifierAndUserId(e,t,r){return new Error(this.returnErrorObject(`Not Matched UserId: ${t} and identifier: ${r} In Third Party App: ${e}`,i.NOT_MATCHED_USER))}notFoundEarnEventByAppIdAndEarnEventAlias(e){return new Error(this.returnErrorObject(`Not Found Earn Event by earn event alias ${e}`,i.NOT_FOUND_EVENT))}invaliedKeyOfEarnEvent(e,t){return new Error(this.returnErrorObject(`Invalied key ${t} in earn event ${e}`,i.INVALID_KEY))}notFoundEarnEventParticipationLog(e,t){return new Error(this.returnErrorObject(`Not Found Earn Event Participation Log by app alias ${e} and request id ${t}`,i.NOT_FOUND_EVENT_PARTICIPATION_LOG))}overFlowedMaximumParticipation(e){return new Error(this.returnErrorObject(`Exceeded the maximum number of Event ${e} participants`,i.EXCEEDED_MAXIMUM_PARTICIPATION))}overFlowedMaximumParticipationSumPerDay(e){return new Error(this.returnErrorObject(`Exceeded the maximum number of Event ${e} participants per a day`,i.EXCEEDED_MAXIMUM_PARTICIPATION_PER_DAY))}overFlowedMaximumReward(e){return new Error(this.returnErrorObject(`Exceeded the maximum reward of Event ${e}`,i.EXCEEDED_MAXIMUM_REWARD))}notEventPeriod(e){return new Error(this.returnErrorObject(`Not Event Period Earn Event: ${e}`,i.NOT_EVENT_PERIOD))}}t.default=o},681:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(r(184)),i=n(r(970)),o=n(r(874)),s=n(r(429)),u=n(r(250));t.default=class{earnEventParticipationLogRepository;earnEventRepository;currencyRepository;earnEventClaimRepository;participationUsecase;earnEventParticipationCurrentUsecase;earnEventClaimUsecase;transferTezosCoinUsecase;earnEventClaimRequestUsecase;constructor(e,t,r,n,E){this.earnEventParticipationLogRepository=t,this.earnEventRepository=r,this.currencyRepository=n,this.earnEventClaimRepository=E,this.earnEventParticipationCurrentUsecase=new s.default(t,r),this.earnEventClaimUsecase=new o.default(this.earnEventParticipationLogRepository,this.earnEventParticipationCurrentUsecase),this.participationUsecase=new a.default(t,r,this.earnEventParticipationCurrentUsecase,this.earnEventClaimUsecase),this.transferTezosCoinUsecase=new u.default(e,n),this.earnEventClaimRequestUsecase=new i.default(t,this.earnEventClaimUsecase,E,this.transferTezosCoinUsecase)}setPoint(e,t,r,n,a){return this.participationUsecase.execute(a??new Date,e,t,r,n)}getClaimInformation(e,t,r){return this.earnEventClaimUsecase.execute(r??!0,e,t)}claim(e,t,r,n){return this.earnEventClaimRequestUsecase.execute(e,t,n??new Date,r)}}},175:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BlockchainNetwork=void 0,t.BlockchainNetwork={ETHEREUM:"ETHEREUM",ETHEREUM_ROPSTEN:"ETHEREUM_ROPSTEN",ETHEREUM_KOVAN:"ETHEREUM_KOVAN",ETHEREUM_RINKEBY:"ETHEREUM_RINKEBY",ETHEREUM_GOERLI:"ETHEREUM_GOERLI",ETHEREUM_LOCAL:"ETHEREUM_LOCAL",BSC:"BSC",BSC_TEST:"BSC_TEST",POLYGON:"POLYGON",POLYGON_TEST:"POLYGON_TEST",SOLANA:"SOLANA",BITCOIN:"BITCOIN",XTZ:"XTZ",XTZ_GHOST:"XTZ_GHOST",IN_MIGRATION:"IN_MIGRATION"}},946:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EarnEventClaimStatus=void 0,t.EarnEventClaimStatus={INCOMING:"INCOMING",COMPLETED_TRANSFER:"COMPLETED_TRANSFER",FAILED_TRANSFER:"FAILED_TRANSFER",FAILED_WITHDRAW:"FAILED_WITHDRAW",COMPLETED:"COMPLETED",CANCELED:"CANCELED"}},35:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EarnEventClaimType=void 0,t.EarnEventClaimType={CONSTANT:"CONSTANT",RATIO_DIVISION:"RATIO_DIVISION"}},669:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EarnEventParticipationLogStatus=void 0,t.EarnEventParticipationLogStatus={COMPLETED:"COMPLETED",CANCELED:"CANCELED",CLAIMED:"CLAIMED"}},996:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EarnEventClaimStatus=t.BlockchainNetwork=t.EarnEventParticipationLogStatus=t.EarnEventClaimType=void 0;const n=r(35);Object.defineProperty(t,"EarnEventClaimType",{enumerable:!0,get:function(){return n.EarnEventClaimType}});const a=r(669);Object.defineProperty(t,"EarnEventParticipationLogStatus",{enumerable:!0,get:function(){return a.EarnEventParticipationLogStatus}});const i=r(175);Object.defineProperty(t,"BlockchainNetwork",{enumerable:!0,get:function(){return i.BlockchainNetwork}});const o=r(946);Object.defineProperty(t,"EarnEventClaimStatus",{enumerable:!0,get:function(){return o.EarnEventClaimStatus}})},970:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=r(996),i=r(828),o=n(r(482)),s=n(r(924));t.default=class{earnEventParticipationLogRepository;earnEventClaimUsecase;earnEventClaimRepository;transferTezosCoinUsecase;errorService=new o.default;constructor(e,t,r,n){this.earnEventParticipationLogRepository=e,this.earnEventClaimUsecase=t,this.earnEventClaimRepository=r,this.transferTezosCoinUsecase=n}async execute(e,t,r,n){const o={userId:t,earnEventId:e},{earnEvent:u,totalReward:E,subCurrencyToCurrencyExchangeRate:l,subCurrencyValue:c}=await this.earnEventClaimUsecase.execute(!1,e,t);if(!u)throw this.log("WARN","Not Found Earn Event",o),this.errorService.notFoundEarnEventException(e);if(u.claimStartAt>r||u.claimEndAt<r)throw this.log("WARN","Not Claimable Period",o),this.errorService.notClaimablePeriod(e);let d=new s.default(u.currency.withdrawalFee??0);const[v,p]=await Promise.all([this.earnEventClaimRepository.findOnlyActiveByEarnEventIdAndUserId(e,t),this.earnEventParticipationLogRepository.findOneByEarnEventAndUserAndApp(e,t)]);if(v.length>0&&(v[0].status===a.EarnEventClaimStatus.INCOMING||v[0].status===a.EarnEventClaimStatus.COMPLETED_TRANSFER)||!u.isAllowParticipationInClaim&&v.length>0){const r=this.errorService.alreadyClaimed(e,t);throw this.log("WARN",r.message,o),r}if(!(0===v.length||u.isAllowParticipationInClaim&&"COMPLETED"===v[0].status)){const r=this.errorService.alreadyClaimed(e,t);throw this.log("WARN",r.message,o),r}const h=new s.default(c??0),m=[{amount:E,currency:u.currency,fee:d,balanceWithdrawalRequestId:(0,i.v4)()}];if(u.subCurrency&&h.gt(0)&&l){const e=u.subCurrency?.withdrawalFee?.mul(l);d=d.plus(e??0),m[0].fee=d,m.push({amount:h,currency:u.subCurrency,fee:new s.default(0),balanceWithdrawalRequestId:(0,i.v4)()})}if(m[0].amount.lte(d)&&m.shift(),0===m.length){const t=this.errorService.notEnoughClaimReward(e);throw this.log("WARN",t.message,o),t}const w=p[0]?.thirdPartyUserId??void 0;this.log("LOG",`Requested Claim - ${m.map((e=>`${e.currency.name}: ${e.amount}`)).join(" and ")} to Address: ${n}.`,o);let _=null;try{return _=await this.earnEventClaimRepository.create(u.id,t,a.EarnEventClaimStatus.COMPLETED_TRANSFER,w),this.log("LOG","Created Claim Entity",o),this.transferTezosCoinUsecase.execute("XTZ",E,n)}catch(e){throw this.log("ERROR",JSON.stringify(e),o),_&&await this.setFailedEarnEventClaim(_),e}}log(e,t,r){const n=`${t} - User: ${r.userId}, EarnEvent: ${r.earnEventId}`;"LOG"===e?console.log(n):"WARN"===e?console.warn(n):console.error(n)}async setFailedEarnEventClaim(e){await this.earnEventClaimRepository.updateFaildById(e.id)}async sleep(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}}},874:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=r(996),i=n(r(924)),o=n(r(482));t.default=class{earnEventParticipationLogRepository;earnEventParticipationCurrentUsecase;eventErrorService=new o.default;constructor(e,t){this.earnEventParticipationLogRepository=e,this.earnEventParticipationCurrentUsecase=t}async execute(e,t,r,n){let a;a=n||await this.earnEventParticipationCurrentUsecase.execute(e,t,r);const{earnEvent:o}=a,s=this.returnPointSumByPointSumArr(a);let u=new i.default(0);const{lowerLimitPoint:E,totalReward:l}=await this.returnTotalReward(a);u=l;let c=new i.default(o.subCurrencyReward??0);return E.gt(s)&&(u=new i.default(0)),u.lte(0)&&(u=new i.default(0),c=new i.default(0)),{earnEvent:o,currentPoint:s,lowerLimitPoint:E,totalReward:u,subCurrencyToCurrencyExchangeRate:void 0,subCurrencyValue:o.subCurrency?c:void 0}}returnPointSumByPointSumArr(e){const{pointSumArr:t}=e;return t.map((e=>e.sum.mul(e.weight))).reduce(((e,t)=>e.plus(t)),new i.default(0))}async returnTotalReward(e){const{earnEvent:t,pointSumArr:r}=e,n=r.map((e=>e.sum.mul(e.weight))).reduce(((e,t)=>e.plus(t)),new i.default(0));let o=new i.default(0),s=new i.default(0);switch(t.claimType){case a.EarnEventClaimType.CONSTANT:o=this.calcConstantValue(t,n);break;case a.EarnEventClaimType.RATIO_DIVISION:const e=await this.calcRatioDivisionValue(t,n);o=e.totalReward,s=e.lowerLimitPoint}return{totalReward:o.toFixedDecimal(),lowerLimitPoint:s}}calcConstantValue(e,t){return e.rewardPerValue?t.mul(e.rewardPerValue):new i.default(0)}async returnLowerLimitPoint(e,t){if(!e.lowerLimitReward)return new i.default(0);let r;return r=t||await this.returnTotalSumValue(e),new i.default(e.lowerLimitReward??0).mul(r).dividedBy(e.maxReward)}async calcRatioDivisionValue(e,t){let r=await this.returnTotalSumValue(e),n=new i.default(0),a=new i.default(0);return e.lowerLimitReward?.gt(0)&&(n=await this.returnLowerLimitPoint(e,r),r=await this.returnTotalSumValueByLowerLimitPoint(e,n)),a=r.gt(0)?t.dividedBy(r).mul(e.maxReward):new i.default(0),{totalReward:a,lowerLimitPoint:n}}async returnTotalSumValue(e){return(await Promise.all(e.pointArr.map((t=>this.earnEventParticipationLogRepository.totalValueByEarnEventAndKey(e.id,t))))).reduce(((e,t)=>e.plus(t)),new i.default(0))}async returnTotalSumValueByLowerLimitPoint(e,t){return(await Promise.all(e.pointArr.map((r=>this.earnEventParticipationLogRepository.totalValueByEarnEventAndLowerLimit(e.id,t,r))))).reduce(((e,t)=>e.plus(t)),new i.default(0))}}},429:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=n(r(924)),i=n(r(482));t.default=class{earnEventParticipationLogRepository;earnEventRepository;earnEventErrorService=new i.default;constructor(e,t){this.earnEventParticipationLogRepository=e,this.earnEventRepository=t}async execute(e,t,r){const n=await this.earnEventRepository.findById(t);if(!n)throw this.earnEventErrorService.notFoundEarnEventException(t);let i=e;n.isAllowParticipationInClaim&&(i=!1);const o=n.pointArr??[],s=r?await this.earnEventParticipationLogRepository.totalValueGroupByKeyByEarnEventAndUserOrThirdPartyIdentifier(t,i,r):await this.earnEventParticipationLogRepository.totalValueGroupByKeyByEarnEvent(t);return{earnEvent:n,pointSumArr:o.map((e=>({...e,sum:new a.default(s.find((t=>t.key===e.key))?._sum.value??0)})))}}}},184:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=r(996),i=n(r(924)),o=n(r(21));t.default=class{earnEventParticipationLogRepository;earnEventRepository;earnEventParticipationCurrentUsecase;earnEventClaimUsecase;errorService=new o.default;constructor(e,t,r,n){this.earnEventParticipationLogRepository=e,this.earnEventRepository=t,this.earnEventParticipationCurrentUsecase=r,this.earnEventClaimUsecase=n}async execute(e,t,r,n,o,s,u,E){const l=new i.default(r).toFixedDecimal(),[c,d,v]=await Promise.all([this.earnEventRepository.findByAppIdAndAlias(t),this.earnEventParticipationLogRepository.findByAppIdAndEarnEventAliasAndUserAndRequestId(t,o),this.earnEventParticipationLogRepository.countByAppAndEarnEventAliasAndNotCurrentUserOrThirdPartyIdentifierDistinct(t,s,u)]);if(!c)throw this.errorService.notFoundEarnEventByAppIdAndEarnEventAlias(t);const p={earnEventAlias:t,earnEventId:c.id,key:n,value:r,requestId:o};if(!(c.eventStartAt<=e&&e<c.eventEndAt||c.isAllowParticipationInClaim&&c.claimStartAt<=e&&e<c.claimEndAt))throw this.log("WARN","Not Earn Event Period",p),this.errorService.notEventPeriod(t);if(c.maxParticipationUserCount&&v>=c.maxParticipationUserCount)throw this.log("WARN","Exceeded the maximum participation user count of Event",p),this.errorService.overFlowedMaximumParticipation(t);if("COMPLETED"!==d?.status&&"CLAIMED"!==d?.status){if(-1===c.pointArr.findIndex((e=>e.key===n)))throw this.log("WARN","Invalied Earn Event Key",p),this.errorService.invaliedKeyOfEarnEvent(t,n);await Promise.all([this.checkMaxReward(c,n,l)]),await this.earnEventParticipationLogRepository.upsertDoNothingByEarnEventAndRequestId(c.id,l,n,o,a.EarnEventParticipationLogStatus.COMPLETED,s,u,E),this.log("LOG","Completed Third Party Earn Event Participation Usecase",p)}else this.log("LOG","Ignored Already Processed request",p)}async checkMaxReward(e,t,r){if(e&&e.claimType===a.EarnEventClaimType.CONSTANT){const n=await this.earnEventParticipationCurrentUsecase.execute(!1,e.id),a=n.pointSumArr.find((e=>e.key===t));if(!a)return;a.sum=a.sum.plus(r);const{totalReward:i}=await this.earnEventClaimUsecase.returnTotalReward(n);if(i.gt(e.maxReward))throw this.errorService.overFlowedMaximumReward(e.alias)}}log(e,t,r){const n=`${t} - RequestId: ${r.requestId} EarnEvent: {id: ${r.earnEventAlias}, alias: ${r.earnEventAlias}, Key: ${r.key}, Value: ${r.value}`;"LOG"===e?console.log(n):"WARN"===e?console.warn(n):console.error(n)}}},250:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=r(165),i=r(176),o=n(r(924));t.default=class{currency;secret;enabled;constructor(e,t){this.currency=t,this.secret=e}async execute(e,t,r){if(!this.secret)throw new Error(`This currency is not available!: ${e}`);const{address:n,privateKey:a}=this.secret,{network:i,tokenDecimal:o}=await this.currency.require(e);if(!i)throw new Error(`Unknown XTZ! ${i}`);const[s,u]=await this.isTransferableAddress(i,n,t,o);if(console.warn(`\n===== Withdrawal ${e} =====\nTransferable: ${s}, Current Balance: ${u}, Transfer Amount: ${t}`),!s)throw new Error("Insufficient balance");const E=this.getWallet(i,a),l=await E.transfer({to:r,amount:t.toNumber()}).send(),c=await l.transactionOperation(),d=await l.confirmation();return{blockNumber:d.block.header.level,transactionHash:l.opHash,isSuccess:d.completed,payload:{opHash:l.opHash,level:d.block.header.level,...c},to:r,from:n,contractAddress:""}}async isTransferable(e,t){const r=this.secret[e];if(!r)throw new Error("No wallet info: Unknown XTZ!");const{address:n}=r,{network:a,tokenDecimal:i}=await this.currency.require(e);if(!a)throw new Error("No currency network info: Unknown XTZ!");return await this.isTransferableAddress(a,n,t,i)}async isTransferableAddress(e,t,r,n){const a=this.getProvider(e),i=await a.tz.getBalance(t.trim()),s=o.default.fromBigNumber(i.toString(),n);return console.warn(`Wallet ${t} ETH Balance: ${i}`),[r.lte(s),s]}getWallet(e,t){const r=this.getProvider(e);return r.setProvider({signer:new a.InMemorySigner(t)}),r.wallet}getProvider(e){return new i.TezosToolkit(e)}}},165:e=>{e.exports=require("@taquito/signer")},176:e=>{e.exports=require("@taquito/taquito")},200:e=>{e.exports=require("decimal.js")},982:e=>{e.exports=require("ethers")},828:e=>{e.exports=require("uuid")}},t={};!function r(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}(681)})();